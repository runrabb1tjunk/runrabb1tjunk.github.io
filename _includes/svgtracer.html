<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор и редактор цветовых зон</title>
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5.5.2"></script>
    <style>
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-section, .output-section, .trace-section {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
            background: #f8f8f8;
            margin-top: 10px;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .controls {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 15px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:disabled {
            background: #cccccc !important;
            cursor: not-allowed;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
        }
        .section-title {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
            margin-top: 0;
        }
        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Стили для редактора внизу страницы */
        #editor-container {
            margin-top: 40px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .editor-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-body {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        #editor-svg-container {
            flex: 1;
            min-width: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 60vh;
            overflow: auto;
            position: relative;
        }
        
        #svg-wrapper {
            transform-origin: center;
            transition: transform 0.2s;
        }
        
        #editor-controls {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 15px;
        }
        
        .controls-section {
            flex: 1;
            min-width: 300px;
            max-width: 100%;
        }
        
        /* Стили для палитры цветов */
        .palette-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .palette-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .palette-color {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .palette-color:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        
        .palette-color.selected {
            transform: scale(1.15);
            box-shadow: 0 0 12px rgba(0,0,0,0.5);
            border: 2px solid #333;
        }
        
        /* Кнопки цветов */
        .color-btn {
            background: #4CAF50;
        }
        .camera-btn {
            background: #FF9800;
        }
        .download-btn {
            background: #9C27B0;
        }
        .trace-btn {
            background: #607D8B;
        }
        
        /* Стили для цветового круга */
        #color-picker-container {
            width: 100%;
            max-width: 400px;
            height: 125px;
            margin: 15px auto;
        }
        .color-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        .color-display {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        .color-values {
            flex: 1;
        }
        .color-value {
            font-family: monospace;
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .selection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .controls-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .editor-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .color-zone { 
            cursor: pointer; 
            transition: opacity 0.2s, filter 0.2s; 
        }
        .color-zone:hover { 
            opacity: 0.9; 
            filter: brightness(1.1); 
        }
        .selected { 
            filter: drop-shadow(0 0 8px rgba(0,0,0,0.5)); 
            transform: scale(1.01);
        }
        #original-color-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        .original-color-display {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        /* Элементы управления масштабированием */
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            padding: 5px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        .zoom-btn {
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Группировка элементов управления */
        .color-controls-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }
        
        .color-picker-section {
            flex: 1;
            min-width: 300px;
        }
        
        .selection-section {
            flex: 1;
            min-width: 300px;
        }
        
        .export-section {
            flex-basis: 100%;
            margin-top: 15px;
        }
        
        /* Исправления для камеры */
        .camera-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 15px;
        }
        
        #cameraPreview {
            width: 100%;
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
        }
        
        .camera-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }
        
        /* Стили для кнопки загрузки */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload-button {
            padding: 8px 15px;
            background: #607D8B;
            color: white;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
        }
        
        #imageInput {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #2c3e50;">Анализатор и редактор цветовых зон</h1>
    
    <div class="mode-buttons" style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button id="startCameraBtn" class="color-btn">Сделать фото</button>
        <button id="uploadFileBtn" class="trace-btn">Загрузить файл</button>
    </div>
    
    <div class="container">
        <div class="input-section">
            <h2 class="section-title">Исходное изображение</h2>
            <canvas id="inputCanvas"></canvas>
            
            <!-- Исправленный блок загрузки файла -->
            <div class="file-upload-wrapper">
                <div class="file-upload-button">Выбрать файл</div>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div class="camera-section" id="cameraSection" style="display: none;">
                <video id="cameraPreview" autoplay playsinline></video>
                <div class="camera-controls">
                    <button id="captureBtn" class="camera-btn">Сделать снимок</button>
                    <button id="cancelCameraBtn" class="btn-danger">Отмена</button>
                </div>
            </div>
        </div>
        
        <div class="output-section">
            <h2 class="section-title">Результат обработки</h2>
            <canvas id="outputCanvas"></canvas>
            <div class="controls">
                <label for="clusterCount">Цветовых зон:</label>
                <input type="number" id="clusterCount" min="2" max="15" value="8" style="width: 60px; padding: 5px;">
                <button id="processBtn" class="color-btn">Обработать</button>
                <button id="downloadBtn" class="download-btn" disabled>Скачать</button>
            </div>
        </div>
    </div>
    
    <div class="trace-section">
        <h2 class="section-title">Трассировка и редактор</h2>
        <div class="controls">
            <span>Источник:</span>
            <select id="traceSource">
                <option value="input">Исходное</option>
                <option value="output">Обработанное</option>
            </select>
            <button id="traceBtn" class="trace-btn">Трассировать в SVG</button>
            <button id="downloadTraceBtn" class="download-btn" disabled>Скачать SVG</button>
        </div>
        <p class="info-text">Трассировка преобразует изображение в векторный формат SVG с 16 цветами</p>
    </div>
    
    <!-- Редактор цветов внизу страницы -->
    <div id="editor-container">
        <div class="editor-header">
            <h2 class="section-title">Редактор цветовых зон</h2>
            <div class="controls-buttons">
                <button id="reset-zoom" class="editor-btn btn-primary">Сбросить масштаб</button>
            </div>
        </div>
        
        <div class="editor-body">
            <div id="editor-svg-container">
                <div id="svg-wrapper"></div>
                <div class="zoom-controls">
                    <button id="zoom-in" class="zoom-btn">+</button>
                    <button id="zoom-out" class="zoom-btn">-</button>
                </div>
            </div>
            
            <!-- Перемещенная панель управления под изображение -->
            <div id="editor-controls">
                <div class="color-controls-group">
                    <div class="color-picker-section controls-section">
                        <h3>Цветовой круг</h3>
                        <div id="color-picker-container"></div>
                        
                        <div class="color-info">
                            <div class="color-display" id="current-color"></div>
                            <div class="color-values">
                                <div class="color-value" id="hex-value">HEX: #FFFFFF</div>
                                <div class="color-value" id="rgb-value">RGB: 255, 255, 255</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="selection-section controls-section">
                        <div class="selection-info">
                            <h3>Выделенная зона</h3>
                            <button id="clear-selection" class="editor-btn btn-primary">Снять выделение</button>
                        </div>
                        <p>Выбрано элементов: <strong id="selected-count">0</strong></p>
                        <p>Исходный цвет: <span id="original-color" style="display:inline-block; width:20px; height:20px; vertical-align:middle;"></span></p>
                        
                        <div class="controls-buttons">
                            <button id="original-color-btn" class="editor-btn">
                                <span>Восстановить исходный цвет</span>
                                <div class="original-color-display"></div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="export-section controls-section">
                    <h3>Экспорт результата</h3>
                    <div class="controls-buttons">
                        <button id="download-edited-svg" class="editor-btn btn-success">Скачать SVG</button>
                        <button id="save-as-png" class="editor-btn btn-primary">Сохранить как PNG</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Секция с палитрой цветов -->
    <div class="palette-section" id="palette-section">
        <h3 class="section-title">Палитра цветов</h3>
        <p>Выберите цвет из палитры для редактирования</p>
        <div class="palette-container" id="palette-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Основные переменные
            const MAX_CLUSTERS = 15;
            const MAX_ITERATIONS = 100;
            const SCALE_FACTOR = 0.25; // Коэффициент уменьшения изображения
            const ZOOM_STEP = 0.1; // Шаг масштабирования

            // Получаем элементы DOM
            const inputCanvas = document.getElementById('inputCanvas');
            const outputCanvas = document.getElementById('outputCanvas');
            const imageInput = document.getElementById('imageInput');
            const clusterCount = document.getElementById('clusterCount');
            const processBtn = document.getElementById('processBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const traceBtn = document.getElementById('traceBtn');
            const downloadTraceBtn = document.getElementById('downloadTraceBtn');
            const traceSource = document.getElementById('traceSource');
            const startCameraBtn = document.getElementById('startCameraBtn');
            const uploadFileBtn = document.getElementById('uploadFileBtn');
            const cameraSection = document.getElementById('cameraSection');
            const cameraPreview = document.getElementById('cameraPreview');
            const captureBtn = document.getElementById('captureBtn');
            const cancelCameraBtn = document.getElementById('cancelCameraBtn');

            // Контексты для canvas
            const inputCtx = inputCanvas.getContext('2d');
            const outputCtx = outputCanvas.getContext('2d');

            // Переменные состояния
            let originalImageData = null;
            let imgWidth = 0;
            let imgHeight = 0;
            let stream = null;
            let currentSVG = null;

            // Элементы редактора
            const editorContainer = document.getElementById('editor-container');
            const editorSvgContainer = document.getElementById('editor-svg-container');
            const svgWrapper = document.getElementById('svg-wrapper');
            const clearSelectionBtn = document.getElementById('clear-selection');
            const downloadEditedSvgBtn = document.getElementById('download-edited-svg');
            const saveAsPngBtn = document.getElementById('save-as-png');
            const originalColorBtn = document.getElementById('original-color-btn');
            const originalColorDisplay = originalColorBtn.querySelector('.original-color-display');
            const paletteSection = document.getElementById('palette-section');
            const paletteContainer = document.getElementById('palette-container');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const resetZoomBtn = document.getElementById('reset-zoom');

            // Переменные для редактора
            let colorPicker = null;
            let svgElement = null;
            let colorMap = new Map();
            let selectedColor = null;
            let selectedPaletteColor = null;
            let originalSvgString = null;
            let currentScale = 1.0; // Текущий масштаб SVG

            // Классы для работы с пикселями
            class Pixel {
                constructor(r, g, b, a) {
                    this.r = r;
                    this.g = g;
                    this.b = b;
                    this.a = a;
                }
            }

            class Centroid {
                constructor(r, g, b, a) {
                    this.r = r;
                    this.g = g;
                    this.b = b;
                    this.a = a;
                }
            }

            // ====================== Основные функции ======================

            // Переключение между режимами камеры и загрузки
            startCameraBtn.addEventListener('click', startCamera);
            
            // Исправление: кнопка "Загрузить файл" теперь работает
            uploadFileBtn.addEventListener('click', () => {
                // Скрываем камеру если открыта
                cameraSection.style.display = 'none';
                closeCamera();
                
                // Активируем клик по скрытому input
                imageInput.click();
            });

            // Загрузка файла
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    loadImage(event.target.result);
                };
                reader.readAsDataURL(file);
            });

            // Обработка изображения
            processBtn.addEventListener('click', function() {
                if (!originalImageData) {
                    alert('Сначала загрузите изображение');
                    return;
                }
                
                const k = Math.min(MAX_CLUSTERS, Math.max(2, parseInt(clusterCount.value) || 8));
                processBtn.disabled = true;
                
                setTimeout(() => {
                    const pixels = extractPixels(originalImageData);
                    const result = kmeans(pixels, k);
                    renderResult(result);
                    downloadBtn.disabled = false;
                    processBtn.disabled = false;
                }, 100);
            });

            // Скачивание результата
            downloadBtn.addEventListener('click', function() {
                const link = document.createElement('a');
                link.download = 'processed_image.png';
                link.href = outputCanvas.toDataURL('image/png');
                link.click();
            });

            // Запуск камеры
            async function startCamera() {
                try {
                    // Скрываем другие элементы
                    document.querySelector('.file-upload-wrapper').style.display = 'none';
                    
                    // Показываем секцию камеры
                    cameraSection.style.display = 'flex';
                    
                    // Остановить предыдущий поток
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Получить доступ к камере
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }, 
                        audio: false 
                    });
                    
                    cameraPreview.srcObject = stream;
                    
                    // Адаптация для мобильных устройств
                    cameraPreview.onloadedmetadata = function() {
                        // Установка соотношения сторон
                        const aspectRatio = cameraPreview.videoWidth / cameraPreview.videoHeight;
                        cameraPreview.style.aspectRatio = aspectRatio;
                    };
                    
                } catch (err) {
                    console.error("Camera error:", err);
                    alert('Не удалось получить доступ к камере: ' + err.message);
                    cameraSection.style.display = 'none';
                    document.querySelector('.file-upload-wrapper').style.display = 'block';
                }
            }

            // Сделать снимок
            captureBtn.addEventListener('click', function() {
                if (!stream) return;
                
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = cameraPreview.videoWidth;
                tempCanvas.height = cameraPreview.videoHeight;
                
                tempCtx.drawImage(cameraPreview, 0, 0, tempCanvas.width, tempCanvas.height);
                
                loadImage(tempCanvas.toDataURL('image/png'));
                closeCamera();
            });

            // Отмена съемки
            cancelCameraBtn.addEventListener('click', closeCamera);

            // Закрыть камеру
            function closeCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                cameraSection.style.display = 'none';
                document.querySelector('.file-upload-wrapper').style.display = 'block';
            }

            // Загрузить изображение
            function loadImage(src) {
                const img = new Image();
                img.onload = function() {
                    // Масштабирование для производительности
                    const maxWidth = 800;
                    const scale = Math.min(1, maxWidth / img.width);
                    imgWidth = img.width * scale;
                    imgHeight = img.height * scale;
                    
                    // Установка размеров canvas (внутренний размер полный)
                    inputCanvas.width = imgWidth;
                    inputCanvas.height = imgHeight;
                    outputCanvas.width = imgWidth;
                    outputCanvas.height = imgHeight;
                    
                    // Уменьшение отображения в 4 раза
                    inputCanvas.style.width = (imgWidth * SCALE_FACTOR) + 'px';
                    inputCanvas.style.height = (imgHeight * SCALE_FACTOR) + 'px';
                    outputCanvas.style.width = (imgWidth * SCALE_FACTOR) + 'px';
                    outputCanvas.style.height = (imgHeight * SCALE_FACTOR) + 'px';
                    
                    // Отрисовка изображения
                    inputCtx.drawImage(img, 0, 0, imgWidth, imgHeight);
                    originalImageData = inputCtx.getImageData(0, 0, imgWidth, imgHeight);
                    
                    // Активация кнопок
                    processBtn.disabled = false;
                    downloadBtn.disabled = true;
                    traceBtn.disabled = false;
                    downloadTraceBtn.disabled = true;
                    
                    // Очистка редактора
                    svgWrapper.innerHTML = '';
                    paletteContainer.innerHTML = '';
                    
                    // Скрываем редактор и палитру
                    editorContainer.style.display = 'none';
                    paletteSection.style.display = 'none';
                    
                    // Показываем кнопку загрузки
                    document.querySelector('.file-upload-wrapper').style.display = 'block';
                };
                img.src = src;
            }

            // Извлечение пикселей
            function extractPixels(imageData) {
                const data = imageData.data;
                const pixels = [];
                for (let i = 0; i < data.length; i += 4) {
                    pixels.push(new Pixel(
                        data[i],     // R
                        data[i + 1], // G
                        data[i + 2], // B
                        data[i + 3]  // A
                    ));
                }
                return pixels;
            }

            // Расчет расстояния между цветами
            function colorDistance(p, c) {
                const dr = p.r - c.r;
                const dg = p.g - c.g;
                const db = p.b - c.b;
                const da = p.a - c.a;
                return dr * dr + dg * dg + db * db + da * da;
            }

            // Инициализация центроидов
            function initCentroids(pixels, k) {
                const centroids = [];
                const numPixels = pixels.length;
                
                // Первый центроид выбирается случайно
                const firstIdx = Math.floor(Math.random() * numPixels);
                centroids.push(new Centroid(
                    pixels[firstIdx].r,
                    pixels[firstIdx].g,
                    pixels[firstIdx].b,
                    pixels[firstIdx].a
                ));
                
                const distances = new Float64Array(numPixels);
                
                for (let c = 1; c < k; c++) {
                    let totalDistance = 0;
                    
                    // Вычисляем расстояние до ближайшего центроида
                    for (let i = 0; i < numPixels; i++) {
                        let minDist = Infinity;
                        
                        for (let j = 0; j < c; j++) {
                            const dist = colorDistance(pixels[i], centroids[j]);
                            if (dist < minDist) minDist = dist;
                        }
                        
                        distances[i] = minDist;
                        totalDistance += minDist;
                    }
                    
                    // Выбираем следующий центроид
                    const threshold = Math.random() * totalDistance;
                    let cumulative = 0;
                    for (let i = 0; i < numPixels; i++) {
                        cumulative += distances[i];
                        if (cumulative >= threshold) {
                            centroids.push(new Centroid(
                                pixels[i].r,
                                pixels[i].g,
                                pixels[i].b,
                                pixels[i].a
                            ));
                            break;
                        }
                    }
                }
                
                return centroids;
            }

            // Основной алгоритм k-means
            function kmeans(pixels, k) {
                const numPixels = pixels.length;
                const assignments = new Int32Array(numPixels).fill(-1);
                const centroids = initCentroids(pixels, k);
                
                let iteration = 0;
                for (; iteration < MAX_ITERATIONS; iteration++) {
                    let changed = false;
                    
                    // Назначение пикселей кластерам
                    for (let i = 0; i < numPixels; i++) {
                        let minDist = Infinity;
                        let bestCluster = -1;
                        
                        for (let j = 0; j < k; j++) {
                            const dist = colorDistance(pixels[i], centroids[j]);
                            if (dist < minDist) {
                                minDist = dist;
                                bestCluster = j;
                            }
                        }
                        
                        if (assignments[i] !== bestCluster) {
                            assignments[i] = bestCluster;
                            changed = true;
                        }
                    }
                    
                    // Проверка сходимости
                    if (!changed && iteration > 5) break;
                    
                    // Пересчет центроидов
                    const newCentroids = Array(k).fill().map(() => ({ r: 0, g: 0, b: 0, a: 0, count: 0 }));
                    
                    for (let i = 0; i < numPixels; i++) {
                        const cluster = assignments[i];
                        newCentroids[cluster].r += pixels[i].r;
                        newCentroids[cluster].g += pixels[i].g;
                        newCentroids[cluster].b += pixels[i].b;
                        newCentroids[cluster].a += pixels[i].a;
                        newCentroids[cluster].count++;
                    }
                    
                    for (let j = 0; j < k; j++) {
                        const c = newCentroids[j];
                        if (c.count > 0) {
                            centroids[j].r = c.r / c.count;
                            centroids[j].g = c.g / c.count;
                            centroids[j].b = c.b / c.count;
                            centroids[j].a = c.a / c.count;
                        }
                    }
                }
                
                console.log(`Выполнено итераций: ${iteration}`);
                return { assignments, centroids, pixels };
            }

            // Отрисовка результата
            function renderResult(result) {
                const { assignments, centroids, pixels } = result;
                const imageData = outputCtx.createImageData(imgWidth, imgHeight);
                const data = imageData.data;
                
                for (let i = 0; i < pixels.length; i++) {
                    const cluster = assignments[i];
                    const idx = i * 4;
                    
                    data[idx] = Math.round(centroids[cluster].r);
                    data[idx + 1] = Math.round(centroids[cluster].g);
                    data[idx + 2] = Math.round(centroids[cluster].b);
                    data[idx + 3] = Math.round(centroids[cluster].a);
                }
                
                outputCtx.putImageData(imageData, 0, 0);
            }

            // ====================== Трассировка изображения ======================
            
            // Обработчик кнопки трассировки
            traceBtn.addEventListener('click', async function() {
                if (!originalImageData) {
                    alert('Сначала загрузите изображение');
                    return;
                }

                traceBtn.disabled = true;
                
                try {
                    // Определяем источник для трассировки
                    const source = traceSource.value;
                    let sourceCanvas;
                    
                    if (source === 'input') sourceCanvas = inputCanvas;
                    else if (source === 'output') sourceCanvas = outputCanvas;
                    
                    // Конвертация в SVG
                    const img = await loadImageToTrace(sourceCanvas.toDataURL('image/png'));
                    const svgString = await convertToSVG(img);
                    currentSVG = svgString;
                    
                    // Открываем редактор с результатом трассировки
                    openEditor(svgString);
                    
                    // Активация кнопки скачивания
                    downloadTraceBtn.disabled = false;
                    
                    console.log('Трассировка завершена успешно');
                    
                } catch (error) {
                    console.error("Ошибка трассировки:", error);
                    alert('Ошибка при трассировке: ' + error.message);
                } finally {
                    traceBtn.disabled = false;
                }
            });

            // Обработчик кнопки скачивания SVG
            downloadTraceBtn.addEventListener('click', function() {
                if (!currentSVG) {
                    alert('Сначала выполните трассировку');
                    return;
                }
                
                const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'traced_image.svg';
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });

            // Загрузка изображения для трассировки
            function loadImageToTrace(src) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => resolve(img);
                    img.src = src;
                });
            }

            // Конвертация в SVG
            function convertToSVG(img) {
                return new Promise((resolve) => {
                    ImageTracer.imageToSVG(
                        img.src,
                        (svgStr) => resolve(svgStr),
                        {
                            // Настройки трассировки
                            ltres: 0.1,
                            qtres: 1,
                            pathomit: 8,
                            colorsampling: 1,
                            numberofcolors: 16,
                            mincolorratio: 0.02,
                            colorquantcycles: 3,
                            scale: 1,
                            linefilter: true,
                            strokewidth: 1,
                            blurradius: 20,
                            blurdelta: 128
                        }
                    );
                });
            }
            
            // ====================== Редактор цветов ======================
            
            // Функция открытия редактора
            function openEditor(svgString) {
                originalSvgString = svgString;
                svgWrapper.innerHTML = svgString;
                svgElement = svgWrapper.querySelector('svg');
                
                // Сбрасываем масштаб
                currentScale = 1.0;
                applyScale();
                
                // Инициализируем редактор
                normalizeSVG();
                createColorMap();
                initColorPicker();
                setupEventHandlers();
                createColorPalette();
                
                // Показываем редактор и палитру
                editorContainer.style.display = 'block';
                paletteSection.style.display = 'block';
                
                // Прокручиваем страницу к редактору
                editorContainer.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Применить масштабирование
            function applyScale() {
                svgWrapper.style.transform = `scale(${currentScale})`;
            }
            
            // Увеличить масштаб
            function zoomIn() {
                currentScale = Math.min(3.0, currentScale + ZOOM_STEP);
                applyScale();
            }
            
            // Уменьшить масштаб
            function zoomOut() {
                currentScale = Math.max(0.1, currentScale - ZOOM_STEP);
                applyScale();
            }
            
            // Сбросить масштаб
            function resetZoom() {
                currentScale = 1.0;
                applyScale();
            }
            
            // Создание палитры цветов
            function createColorPalette() {
                paletteContainer.innerHTML = '';
                const uniqueColors = Array.from(colorMap.keys());
                
                uniqueColors.forEach(color => {
                    const colorBox = document.createElement('div');
                    colorBox.className = 'palette-color';
                    colorBox.style.backgroundColor = color;
                    colorBox.dataset.color = color;
                    
                    colorBox.addEventListener('click', function() {
                        // Снимаем выделение с предыдущего цвета
                        if (selectedPaletteColor) {
                            selectedPaletteColor.classList.remove('selected');
                        }
                        
                        // Выделяем текущий цвет
                        this.classList.add('selected');
                        selectedPaletteColor = this;
                        
                        // Выбираем цветовую зону
                        selectColorZone(color);
                    });
                    
                    paletteContainer.appendChild(colorBox);
                });
            }
            
            // Нормализация SVG элементов
            function normalizeSVG() {
                const elements = svgElement.querySelectorAll('*');
                elements.forEach(el => {
                    const fill = el.getAttribute('fill') || '';
                    if (fill && fill !== 'none' && fill !== 'transparent') {
                        el.classList.add('color-zone');
                        el.dataset.originalFill = fill;
                    }
                });
            }
            
            // Создание карты цветов
            function createColorMap() {
                colorMap = new Map();
                const colorZones = svgElement.querySelectorAll('.color-zone');
                
                colorZones.forEach(zone => {
                    const color = normalizeColor(zone.dataset.originalFill);
                    if (!colorMap.has(color)) {
                        colorMap.set(color, []);
                    }
                    colorMap.get(color).push(zone);
                });
            }
            
            // Инициализация цветового круга
            function initColorPicker() {
                colorPicker = new iro.ColorPicker('#color-picker-container', {
                    width: 140,
                    color: "#3498db",
                    layout: [
                        { 
                            component: iro.ui.Wheel,
                            options: { wheelLightness: false }
                        },
                        { 
                            component: iro.ui.Slider,
                            options: { sliderType: 'hue' }
                        }
                    ]
                });
            }
            
            // Настройка обработчиков событий
            function setupEventHandlers() {
                const currentColorDisplay = document.getElementById('current-color');
                const hexValue = document.getElementById('hex-value');
                const rgbValue = document.getElementById('rgb-value');
                const selectedCount = document.getElementById('selected-count');
                const originalColor = document.getElementById('original-color');
                
                // Обработчики масштабирования
                zoomInBtn.addEventListener('click', zoomIn);
                zoomOutBtn.addEventListener('click', zoomOut);
                resetZoomBtn.addEventListener('click', resetZoom);
                
                // Обработчик клика по SVG
                svgElement.addEventListener('click', e => {
                    const target = e.target.closest('.color-zone');
                    if (!target) {
                        clearSelection();
                        return;
                    }
                    
                    const color = normalizeColor(target.dataset.originalFill);
                    selectColorZone(color);
                });
                
                // Обработчик изменения цвета
                colorPicker.on('color:change', (color) => {
                    currentColorDisplay.style.backgroundColor = color.hexString;
                    updateColorValues(color);
                    
                    if (selectedColor) {
                        const newColor = color.hexString;
                        const zones = colorMap.get(selectedColor);
                        
                        zones.forEach(zone => {
                            zone.setAttribute('fill', newColor);
                        });
                        
                        updateColorMap(selectedColor, newColor);
                        selectedColor = newColor.toLowerCase();
                        
                        // Обновляем палитру
                        updatePaletteColor(selectedColor, newColor);
                    }
                });
                
                // Обработчик снятия выделения
                clearSelectionBtn.addEventListener('click', clearSelection);
                
                // Обработчик восстановления исходного цвета
                originalColorBtn.addEventListener('click', () => {
                    if (!selectedColor) return;
                    
                    const zones = colorMap.get(selectedColor);
                    if (!zones) return;
                    
                    const originalColor = zones[0].dataset.originalFill;
                    
                    zones.forEach(zone => {
                        zone.setAttribute('fill', originalColor);
                    });
                    
                    colorPicker.color.hexString = originalColor;
                    currentColorDisplay.style.backgroundColor = originalColor;
                    updateColorValues(colorPicker.color);
                    
                    updateColorMap(selectedColor, originalColor);
                    selectedColor = originalColor.toLowerCase();
                    
                    // Обновляем палитру
                    updatePaletteColor(selectedColor, originalColor);
                });
                
                // Обработчик скачивания SVG
                downloadEditedSvgBtn.addEventListener('click', () => {
                    const serializer = new XMLSerializer();
                    const svgString = serializer.serializeToString(svgElement);
                    
                    const blob = new Blob([svgString], {type: 'image/svg+xml'});
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'edited-image.svg';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
                // Обработчик сохранения как PNG
                saveAsPngBtn.addEventListener('click', () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const svgData = new XMLSerializer().serializeToString(svgElement);
                    const img = new Image();
                    
                    const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svgBlob);
                    
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        const pngUrl = canvas.toDataURL('image/png');
                        
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = 'edited-image.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        URL.revokeObjectURL(url);
                    };
                    
                    img.src = url;
                });
            }
            
            // Функция выделения цветовой зоны
            function selectColorZone(color) {
                clearSelection();
                
                const zones = colorMap.get(color);
                if (!zones) return;
                
                zones.forEach(zone => {
                    zone.classList.add('selected');
                });
                
                selectedColor = color;
                document.getElementById('current-color').style.backgroundColor = color;
                document.getElementById('original-color').style.backgroundColor = color;
                originalColorDisplay.style.backgroundColor = color;
                document.getElementById('selected-count').textContent = zones.length;
                
                // Выделяем соответствующий цвет в палитре
                const paletteColors = paletteContainer.querySelectorAll('.palette-color');
                paletteColors.forEach(box => {
                    if (box.dataset.color === color) {
                        box.classList.add('selected');
                        selectedPaletteColor = box;
                    }
                });
                
                colorPicker.color.hexString = color;
                updateColorValues(colorPicker.color);
            }
            
            // Функция снятия выделения
            function clearSelection() {
                const selectedZones = svgElement.querySelectorAll('.color-zone.selected');
                selectedZones.forEach(zone => {
                    zone.classList.remove('selected');
                });
                
                selectedColor = null;
                document.getElementById('current-color').style.backgroundColor = '#FFFFFF';
                document.getElementById('original-color').style.backgroundColor = 'transparent';
                document.getElementById('selected-count').textContent = '0';
                
                // Снимаем выделение с палитры
                if (selectedPaletteColor) {
                    selectedPaletteColor.classList.remove('selected');
                    selectedPaletteColor = null;
                }
            }
            
            // Обновление карты цветов
            function updateColorMap(oldColor, newColor) {
                const zones = colorMap.get(oldColor);
                colorMap.delete(oldColor);
                colorMap.set(newColor.toLowerCase(), zones);
            }
            
            // Обновление цвета в палитре
            function updatePaletteColor(oldColor, newColor) {
                const paletteColors = paletteContainer.querySelectorAll('.palette-color');
                paletteColors.forEach(box => {
                    if (box.dataset.color === oldColor) {
                        box.style.backgroundColor = newColor;
                        box.dataset.color = newColor.toLowerCase();
                    }
                });
            }
            
            // Обновление значений цветов в UI
            function updateColorValues(color) {
                document.getElementById('hex-value').textContent = `HEX: ${color.hexString}`;
                document.getElementById('rgb-value').textContent = `RGB: ${color.rgb.r}, ${color.rgb.g}, ${color.rgb.b}`;
            }
            
            // Нормализация цвета
            function normalizeColor(color) {
                if (color.startsWith('rgb')) {
                    const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*\d+\.?\d*)?\)/);
                    if (match) {
                        const r = parseInt(match[1]).toString(16).padStart(2, '0');
                        const g = parseInt(match[2]).toString(16).padStart(2, '0');
                        const b = parseInt(match[3]).toString(16).padStart(2, '0');
                        return `#${r}${g}${b}`.toLowerCase();
                    }
                }
                return color.toLowerCase();
            }
        });
    </script>
</body>
</html>